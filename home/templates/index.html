<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

    <div class="container mt-5">
        <h1 class="text-center">To-Do List</h1>

        <!-- Form for adding new to-do -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">Add New Task</h5>
                <form id="todoForm">
                    <div class="mb-3">
                        <label for="title" class="form-label">Task Title</label>
                        <input type="text" class="form-control" id="title" placeholder="Task title" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Task Description</label>
                        <textarea class="form-control" id="description" rows="3" placeholder="Task description"
                            required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Task</button>
                </form>
            </div>
        </div>

        <!-- List of tasks -->
        <div class="mt-5">
            <h3>Task List</h3>
            <ul id="todoList" class="list-group">
                <!-- Tasks will be added here dynamically -->
            </ul>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        const API_URL = 'http://todo-rest-api-production-9c28.up.railway.app/api/todos/';

       // Function to fetch and display all tasks
        function fetchTodos() {
            $.ajax({
                url: API_URL,
                method: 'GET',
                success: function (todos) {
                    $('#todoList').empty();  // Clear current list
                    todos.forEach(todo => {
                        const completedClass = todo.completed ? 'text-decoration-line-through' : ''; // Strike-through if completed
                        const checked = todo.completed ? 'checked' : ''; // Checkbox checked if completed
                        
                        $('#todoList').append(`
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="form-check">
                                <!-- Checkbox for the todo item -->
                                <input class="form-check-input" type="checkbox" id="check${todo.id}" ${checked} onchange="toggleComplete(${todo.id})">
                                <label class="form-check-label ${completedClass}" for="check${todo.id}">
                                    <h5>${todo.title}</h5>
                                    <p>${todo.description}</p>
                                </label>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-warning me-2" onclick="editTask(${todo.id})">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteTask(${todo.id})">Delete</button>
                            </div>
                        </li>
                    `);
                    });
                }
            });
        }

        // Function to toggle task completion
        function toggleComplete(id) {
            // Fetch the current task details
            const checkbox = document.getElementById(`check${id}`);
            const isCompleted = checkbox.checked;

            // Fetch the existing task title and description from the DOM
            const title = checkbox.closest('li').querySelector('h5').innerText;
            const description = checkbox.closest('li').querySelector('p').innerText;

            // Update the completed status on the server
            $.ajax({
                url: API_URL + id + '/',
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ title: title, description: description, completed: isCompleted }), // Include all required fields
                success: function () {
                    fetchTodos();  // Refresh the task list to reflect the new completion state
                }
            });
        }


        // Function to add a new task
        $('#todoForm').submit(function (event) {
            event.preventDefault();  // Prevent form submission

            const newTodo = {
                title: $('#title').val(),
                description: $('#description').val(),
                completed: false
            };

            $.ajax({
                url: API_URL,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(newTodo),
                success: function () {
                    $('#title').val('');  // Clear form
                    $('#description').val('');
                    fetchTodos();  // Refresh the task list
                }
            });
        });

        // Function to delete a task
        function deleteTask(id) {
            $.ajax({
                url: API_URL + id + '/',
                method: 'DELETE',
                success: function () {
                    fetchTodos();  // Refresh the task list
                }
            });
        }

        // Function to edit a task (open a modal with form to edit)
        function editTask(id) {
            const todo = $('#todoList').find(`[data-id="${id}"]`);

            const newTitle = prompt("Edit title:", todo.title);
            const newDescription = prompt("Edit description:", todo.description);

            if (newTitle && newDescription) {
                $.ajax({
                    url: API_URL + id + '/',
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({ title: newTitle, description: newDescription, completed: false }),
                    success: function () {
                        fetchTodos();  // Refresh the task list
                    }
                });
            }
        }

        // Initial fetch of tasks when page loads
        $(document).ready(function () {
            fetchTodos();
        });
    </script>

</body>

</html>